<?php

/**
 * @file
 * Hooks for wateraid_core module.
 */

use Drupal\Core\Render\BubbleableMetadata;
use Drupal\node\NodeInterface;
use Drupal\pathauto\Entity\PathautoPattern;
use Drupal\pathauto\PathautoPatternInterface;

/**
 * Implements hook_pathauto_pattern_alter().
 */
function wateraid_core_pathauto_pattern_alter(PathautoPatternInterface $pattern, array $context): void {
  // Only alter for node patterns.
  if ($context['module'] !== 'node' || empty($context['data']['node'])) {
    return;
  }

  /** @var \Drupal\node\NodeInterface $node */
  $node = $context['data']['node'];
  if ($node->bundle() === 'webform') {
    $has_donate_webform = FALSE;
    /** @var \Drupal\webform\WebformInterface|false $webform */
    $webform = !$node->get('webform')->isEmpty() ? $node->get('webform')->first()->entity : FALSE;
    if ($webform && in_array('Donation', $webform->get('categories'))) {
      $has_donate_webform = TRUE;
    }
    // If the webform node type references a donate webform, we change the
    // pathauto path.
    if ($has_donate_webform) {
      $pattern->setPattern(PathautoPattern::load('webform_with_donate_form')->getPattern());
    }
    else {
      $pattern->setPattern(PathautoPattern::load('webform')->getPattern());
    }
  }
}

/**
 * Implements hook_token_info_alter().
 */
function wateraid_core_token_info_alter(&$data): void {
  $data['tokens']['group_relationship']['node'] = [
    'name' => t('Relationship Content'),
    'description' => t('The content linked to the group.'),
    'module' => 'wateraid_core',
    'type' => 'node',
  ];

  // Add token for node entities.
  $data['tokens']['node']['group-slug'] = [
    'name' => t('Group slug'),
    'description' => t('The URL prefix for the node based on its group membership (e.g., "jp", "in", "uk").'),
  ];
}

/**
 * Implements hook_tokens().
 */
function wateraid_core_tokens($type, $tokens, array $data, array $options, BubbleableMetadata $bubbleable_metadata): array {
  $replacements = [];

  if (isset($data['entity_type']) && $data['entity_type'] == 'group_relationship' && isset($data['entity'])) {
    $token_service = \Drupal::token();
    $entity =  $data['entity']->getEntity();

    if ($entity instanceof NodeInterface) {
      if ($node_tokens = $token_service->findWithPrefix($tokens, 'node')) {
        $replacements += $token_service->generate('node', $node_tokens, ['node' => $entity], $options, $bubbleable_metadata);
      }
    }
  }

  // Handle node:group-slug token.
  if ($type === 'node' && !empty($data['node'])) {
    /** @var \Drupal\node\NodeInterface $node */
    $node = $data['node'];

    foreach ($tokens as $name => $original) {
      if ($name === 'group-slug') {
        // Load the group relationship for this node.
        $relationships = \Drupal\group\Entity\GroupRelationship::loadByEntity($node);

        if (!empty($relationships)) {
          // Get the first group relationship (nodes should only be in one group).
          $relationship = reset($relationships);
          $group = $relationship->getGroup();

          // Get the slug directly from the group's field_slug field.
          if ($group->hasField('field_slug')) {
            $slug = $group->get('field_slug')->value;
            if ($slug) {
              // Remove leading slash if present.
              $replacements[$original] = ltrim($slug, '/');
              // Add cache tags for the group.
              $bubbleable_metadata->addCacheTags($group->getCacheTags());
            }
            else {
              // No slug value - return empty string.
              $replacements[$original] = '';
            }
          }
          else {
            // Fallback to group title if field_slug is not available.
            $replacements[$original] = $group->label();
            $bubbleable_metadata->addCacheTags($group->getCacheTags());
          }
        }
        else {
          // Node is not in a group - return empty string.
          $replacements[$original] = '';
        }
      }
    }
  }

  return $replacements;
}

/**
 * Implements hook_entity_type_alter().
 */
function wateraid_core_entity_type_alter(array &$entity_types): void {
  if (isset($entity_types['user'])) {
    $entity_types['user']->setClass('\Drupal\wateraid_core\Entity\WaUser');
  }
}
