<?php

/**
 * @file
 * Primary module hooks for WaterAid Group module.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Language\LanguageInterface;
use Drupal\Core\Url;
use Drupal\node\NodeInterface;

/**
 * Implements hook_form_BASE_FORM_ID_alter() for node_form.
 */
function wateraid_group_form_node_form_alter(&$form, FormStateInterface $form_state, $form_id): void {

  // Check if we're in a group context by looking at the route.
  $route_name = \Drupal::routeMatch()->getRouteName();

  // If this is our view structure form, prevent anyone being able to save or
  // delete the node through it. They are only meant to be looking.
  if ($route_name == 'wateraid_group.node_structure') {
    foreach (['delete', 'submit'] as $action) {
      if (isset($form['actions'][$action]['#access'])) {
        $form['actions'][$action]['#access'] = FALSE;
      }
    }

    $form['#attached']['library'][] = 'wateraid_group/node_structure';
  }
  // If we're already in a group creation route, don't show the warning.
  elseif (!str_starts_with($route_name, 'entity.group_relationship.create_form')) {

    // Only show warning on node creation (not edit).
    /** @var \Drupal\node\NodeInterface $node */
    $node = $form_state->getFormObject()->getEntity();
    if (!$node->isNew()) {
      // Display warning message directing users to create content within a Site.
      $group_list_url = Url::fromRoute('entity.group.collection')->toString();
      \Drupal::messenger()->addWarning(
        t('Content should be created from within a Site (Group). Please navigate to <a href="@url">Sites</a> and create content there to ensure proper organization and URL structure.', [
          '@url' => $group_list_url,
        ])
      );
    }
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function wateraid_group_form_menu_link_content_form_alter(&$form, FormStateInterface $form_state, $form_id): void {
  if (isset($form['link']['widget'][0]['uri'])) {
    if ($form['link']['widget'][0]['uri']['#type'] == 'entity_autocomplete') {

      // Override the autocomplete on menu links to use our view that prefixes
      // with the group slug.
      $form['link']['widget'][0]['uri']['#selection_handler'] = 'views';
      $form['link']['widget'][0]['uri']['#selection_settings'] = [
        'view' => [
          'view_name' => 'entity_references',
          'display_name' => 'entity_reference_1',
          'arguments' => [],
        ],
        'match_operator' => 'CONTAINS',
        'match_limit' => 10,
      ];
    }
  }
}

/**
 * Implements hook_entity_insert().
 */
function wateraid_group_entity_insert(EntityInterface $entity): void {
  wateraid_group_maybe_reset_language_map($entity);
}

/**
 * Implements hook_entity_update().
 */
function wateraid_group_entity_update(EntityInterface $entity): void {
  wateraid_group_maybe_reset_language_map($entity);
}

/**
 * Implements hook_entity_delete().
 */
function wateraid_group_entity_delete(EntityInterface $entity): void {
  wateraid_group_maybe_reset_language_map($entity);
}

/**
 * Clears the cached group language map when relevant entities change.
 */
function wateraid_group_maybe_reset_language_map(EntityInterface $entity): void {
  if ($entity->getEntityTypeId() !== 'group') {
    return;
  }
  if ($entity->bundle() !== 'wateraid_site') {
    return;
  }

  \Drupal::service('wateraid_group.group_language_map')->reset();
}

/**
 * Implements hook_language_types_info_alter().
 */
function wateraid_group_language_types_info_alter(array &$language_types): void {
  $language_types[LanguageInterface::TYPE_URL]['name'] = t('URL language');
  $language_types[LanguageInterface::TYPE_URL]['description'] = t('Language detected from URL path segments.');
  $language_types[LanguageInterface::TYPE_URL]['locked'] = FALSE;
}

/**
 * Implements hook_preprocess_HOOK().
 */
function wateraid_group_preprocess_html(&$variables): void {
  $gtm_code = NULL;

  /** @var \Drupal\group\Entity\GroupInterface $group */
  if ($group = \Drupal::routeMatch()->getParameter('group')) {
    $gtm_code = $group->get('field_google_tag_id')->getString();
  }

  // If the group has provided a GTM account, override the default.
  if ($gtm_code) {
    if (isset($variables['page']['#attached']['drupalSettings']['gtm']['tagIds'][0])) {
      $variables['page']['#attached']['drupalSettings']['gtm']['tagIds'][0] = $gtm_code;
    }

    /** @var \Drupal\Core\Url $gtm_url */
    if ($gtm_url = $variables['page_top']['google_tag_gtm_iframe'][0]['#url'] ?? NULL) {
      $options = $gtm_url->getOptions();

      if (isset($options['query']['id'])) {
        $options['query']['id'] = $gtm_code;
      }

      $gtm_url->setOptions($options);
      $variables['page_top']['google_tag_gtm_iframe'][0]['#url'] = $gtm_url;
    }
  }

  // If this is our view structure page, it needs the gin edit form class adding
  // to display the sidebar properly.
  if (\Drupal::routeMatch()->getRouteName() == 'wateraid_group.node_structure') {
    $variables['attributes']['class'][] = 'gin--edit-form';
    $title = t('View the @type structure', [
      '@type' => ucwords(str_replace('_', ' ', $variables['node_type'])),
    ]);
    $variables['head_title']['title'] = $title;
  }
}

/**
 * Implements hook_entity_operation_alter().
 */
function wateraid_group_entity_operation_alter(array &$operations, EntityInterface $entity): void {
  if ($entity instanceof NodeInterface) {

    // If our node structure operation is not present, add it with a copy of the
    // other link's options.
    if (!isset($operations['structure'])) {
      $first = reset($operations);

      $options = (isset($first['url'])) ? $first['url']->getOptions() : [];

      if (isset($options['attributes']['aria-label'])) {
        $options['attributes']['aria-label'] = t('View the structure of @entity_label', [
          '@entity_label' => $entity->label(),
        ]);
      }

      $operations['structure'] = [
        'title' => t('Structure'),
        'weight' => 60,
        'url' => Url::fromRoute('wateraid_group.node_structure', ['node' => $entity->id()], $options),
      ];
    }
  }
}
